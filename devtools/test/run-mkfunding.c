#include "config.h"
#include "config_test.h"
#include <assert.h>
#include <bitcoin/signature.h>
#include <bitcoin/tx.h>
#include <common/setup.h>
#include <common/utils.h>
#include <stdio.h>

/* AUTOGENERATED MOCKS START */
	// tools/update-mocks.sh said "...build succeeded without stubs"
/* AUTOGENERATED MOCKS END */

int test_main(int argc, char *argv[]);
int test_bitcoin_tx_add_input(struct bitcoin_tx *tx,
			 const struct bitcoin_outpoint *outpoint,
			 u32 sequence,
			 const u8 *scriptSig,
			 struct amount_sat amount,
			 const u8 *scriptPubkey,
			 const u8 *input_wscript);
void test_bitcoin_tx_finalize(struct bitcoin_tx *tx);
bool test_bitcoin_tx_check(const struct bitcoin_tx *tx);
void test_bitcoin_tx_input_set_script(struct bitcoin_tx *tx,
				      int innum,
				      u8 *script);
void test_sign_tx_input(const struct bitcoin_tx *tx,
		   unsigned int in,
		   const u8 *subscript,
		   const u8 *witness_script,
		   const struct privkey *privkey,
		   const struct pubkey *key,
		   enum sighash_type sighash_type,
		   struct bitcoin_signature *sig);
void test_bitcoin_txid(const struct bitcoin_tx *tx, struct bitcoin_txid *txid);
u8 *test_linearize_tx(const tal_t *ctx, const struct bitcoin_tx *tx);
int test_printf(const char *format, ...);

#define main test_main
#define bitcoin_tx_add_input test_bitcoin_tx_add_input
#define bitcoin_tx_finalize test_bitcoin_tx_finalize
#define bitcoin_tx_check test_bitcoin_tx_check
#define bitcoin_tx_input_set_script test_bitcoin_tx_input_set_script
#define sign_tx_input test_sign_tx_input
#define bitcoin_txid(tx, txid) test_bitcoin_txid(tx, txid)
#define linearize_tx test_linearize_tx
#define printf test_printf
  #include "../mkfunding.c"
#undef main

int test_bitcoin_tx_add_input(struct bitcoin_tx *tx UNUSED,
			 const struct bitcoin_outpoint *outpoint UNUSED,
			 u32 sequence UNUSED,
			 const u8 *scriptSig UNUSED,
			 struct amount_sat amount UNUSED,
			 const u8 *scriptPubkey UNUSED,
			 const u8 *input_wscript UNUSED)
{
	printf("mock bitcoin_tx_add_input\n");
	return 0;
}

void test_bitcoin_tx_finalize(struct bitcoin_tx *tx UNUSED)
{
	printf("mock bitcoin_tx_finalize\n");
}

bool test_bitcoin_tx_check(const struct bitcoin_tx *tx UNUSED)
{
	printf("mock bitcoin_tx_check\n");
	return true;
}

void test_bitcoin_tx_input_set_script(struct bitcoin_tx *tx UNUSED,
				      int innum UNUSED,
				      u8 *script UNUSED)
{
	printf("mock bitcoin_tx_input_set_script\n");
}

void test_sign_tx_input(const struct bitcoin_tx *tx UNUSED,
		   unsigned int in UNUSED,
		   const u8 *subscript UNUSED,
		   const u8 *witness_script UNUSED,
		   const struct privkey *privkey UNUSED,
		   const struct pubkey *key UNUSED,
		   enum sighash_type sighash_type UNUSED,
		   struct bitcoin_signature *sig UNUSED)
{
	printf("mock sign_tx_input\n");
}

void test_bitcoin_txid(const struct bitcoin_tx *tx UNUSED,
		       struct bitcoin_txid *txid UNUSED)
{
	printf("mock bitcoin_txid\n");
}

u8 *test_linearize_tx(const tal_t *ctx, const struct bitcoin_tx *tx)
{
	printf("mock linearize_tx\n");
	return NULL;
}

int test_printf(const char *fmt UNUSED, ...)
{
	return 0;
}


static int testcase1(int argc UNUSED, char *argv[])
{
	printf("\ntestcase 1\n");
	char *fake_argv[] = {
		argv[0],
		"16835ac8c154b616baac524163f41fb0c4f82c7b972ad35d4d6f18d854f6856b",
		"1",
		"0.01btc",
		"253",
		"76edf0c303b9e692da9cb491abedef46ca5b81d32f102eb4648461b239cb0f99",
		"0000000000000000000000000000000000000000000000000000000000000010",
		"0000000000000000000000000000000000000000000000000000000000000020",
		NULL
	};
	assert(test_main(8, fake_argv) == 0);
	assert(!taken_any());
	return 0;
}

static int testcase2(int argc UNUSED, char *argv[])
{
	printf("\ntestcase 2\n");
	char *fake_argv[] = {
		argv[0],
		"16835ac8c154b616baac524163f41fb0c4f82c7b972ad35d4d6f18d854f6856b",
		"0",
		"0.02btc",
		"253",
		"bc2f48a76a6b8815940accaf01981d3b6347a68fbe844f81c50ecbadf27cd179",
		"0000000000000000000000000000000000000000000000000000000000000030",
		"0000000000000000000000000000000000000000000000000000000000000040",
		NULL
	};
	assert(test_main(8, fake_argv) == 0);
	assert(!taken_any());
	return 0;
}

static int testcase3(int argc UNUSED, char *argv[])
{
	printf("\ntestcase 3\n");
	char *fake_argv[] = {
		argv[0],
		"16835ac8c154b616baac524163f41fb0c4f82c7b972ad35d4d6f18d854f6856b",
		"3",
		"0.03btc",
		"253",
		"16c5027616e940d1e72b4c172557b3b799a93c0582f924441174ea556aadd01c",
		"0000000000000000000000000000000000000000000000000000000000000050",
		"0000000000000000000000000000000000000000000000000000000000000060",
		NULL
	};
	assert(test_main(8, fake_argv) == 0);
	assert(!taken_any());
	return 0;
}


int main(int argc, char *argv[])
{
	common_setup(argv[0]);
	assert(!testcase1(argc, argv));
	assert(!testcase2(argc, argv));
	assert(!testcase3(argc, argv));
	common_shutdown();
	return 0;
}
